# Redis Configuration for FinClick.AI Platform
# Production-ready configuration with security and performance optimizations

################################## NETWORK #####################################

# Accept connections on any interface
bind 0.0.0.0

# Default port
port 6379

# TCP listen() backlog
tcp-backlog 511

# Close connection after N seconds of inactivity
timeout 300

# TCP keepalive
tcp-keepalive 60

################################# GENERAL #####################################

# Run as daemon
daemonize no

# Specify the server verbosity level
loglevel notice

# Specify the log file name
logfile "/var/log/redis/redis-server.log"

# Number of databases
databases 16

################################ SNAPSHOTTING  ################################

# Save the DB on disk
save 900 1    # Save after 900 sec if at least 1 key changed
save 300 10   # Save after 300 sec if at least 10 keys changed
save 60 10000 # Save after 60 sec if at least 10000 keys changed

# Compress string objects using LZF when dump .rdb databases
rdbcompression yes

# Checksum the RDB file
rdbchecksum yes

# The filename where to dump the DB
dbfilename finclick_dump.rdb

# Working directory for DB files
dir /var/lib/redis/

################################# REPLICATION #################################

# Master-Replica setup (if needed)
# replica-serve-stale-data yes
# replica-read-only yes
# repl-diskless-sync no
# repl-diskless-sync-delay 5

################################## SECURITY ###################################

# Require password for authentication
requirepass FinClick2024SecureRedisPassword!

# Rename dangerous commands
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command EVAL ""
rename-command DEBUG ""
rename-command CONFIG "FINCLICK_CONFIG_8a3f9b2c"

################################### LIMITS ####################################

# Maximum number of connected clients
maxclients 10000

# Memory limit (adjust based on available RAM)
maxmemory 2gb

# Memory eviction policy
maxmemory-policy allkeys-lru

# Maximum samples for LRU eviction
maxmemory-samples 5

################################ LAZY FREEING ################################

# Lazy freeing for performance
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

############################# KERNEL OOM CONTROL ##############################

# OOM score adjustment
oom-score-adj no

####################### KERNEL TRANSPARENT HUGEPAGE CONTROL ##################

# Disable THP support
disable-thp yes

############################## APPEND ONLY FILE ###############################

# Enable AOF persistence
appendonly yes

# AOF filename
appendfilename "finclick_appendonly.aof"

# AOF fsync policy
appendfsync everysec

# Don't fsync during rewrites
no-appendfsync-on-rewrite no

# Auto-rewrite AOF when it grows too large
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Load truncated AOF file on startup
aof-load-truncated yes

# Use RDB-AOF hybrid persistence
aof-use-rdb-preamble yes

################################ LUA SCRIPTING  ###############################

# Max execution time for Lua scripts (milliseconds)
lua-time-limit 5000

################################## SLOW LOG ###################################

# Slow query log
slowlog-log-slower-than 10000
slowlog-max-len 128

################################ LATENCY MONITOR ##############################

# Latency monitoring
latency-monitor-threshold 100

############################# EVENT NOTIFICATION ##############################

# Keyspace notifications
notify-keyspace-events "Ex"

############################### ADVANCED CONFIG ###############################

# Hash table rehashing
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List compression
list-max-ziplist-size -2
list-compress-depth 0

# Set optimization
set-max-intset-entries 512

# Sorted set optimization
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog optimization
hll-sparse-max-bytes 3000

# Streams optimization
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active rehashing
activerehashing yes

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Background saving errors
stop-writes-on-bgsave-error yes

# RDB file corruption handling
rdbchecksum yes

# Frequency of rehashing the main dictionary
hz 10

# Enable dynamic HZ
dynamic-hz yes

# AOF rewrite incremental fsync
aof-rewrite-incremental-fsync yes

# RDB save incremental fsync
rdb-save-incremental-fsync yes

################################## MODULES ####################################

# Load Redis modules (if needed)
# loadmodule /path/to/module.so

################################## TLS/SSL ####################################

# TLS Configuration (uncomment for production with SSL)
# tls-port 6380
# tls-cert-file /etc/redis/tls/redis.crt
# tls-key-file /etc/redis/tls/redis.key
# tls-ca-cert-file /etc/redis/tls/ca.crt
# tls-dh-params-file /etc/redis/tls/redis.dh
# tls-protocols "TLSv1.2 TLSv1.3"
# tls-ciphers "ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256"
# tls-auth-clients yes

################################## CUSTOM ####################################

# Custom configurations for FinClick.AI

# Session timeout (30 minutes)
# This will be handled by application logic

# Rate limiting configurations
# These will be implemented via application logic using Redis

# Cache configurations for different data types:
# - User sessions: 30 minutes TTL
# - Financial data cache: 5 minutes TTL
# - Analytics cache: 1 hour TTL
# - API rate limits: 1 hour window

# Memory usage optimization for different key types:
# sessions:* - Hash data structure for user sessions
# cache:* - String/Hash for general caching
# rate_limit:* - String with TTL for rate limiting
# notifications:* - List for notification queues
# analytics:* - Hash for analytics caching